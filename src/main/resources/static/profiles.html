<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>DualNet - Profile</title>
  <style>body{font-family:Arial,Helvetica,sans-serif;margin:20px} .box{max-width:900px;margin:0 auto} .result{padding:10px;border:1px solid #e6e6e6;border-radius:6px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center} .meta{color:#666;font-size:13px}</style>
</head>
<body>
  <div id="nav-placeholder"></div>
  <script>
    (function(){
      fetch('/navbar.html')
        .then(r => r.ok ? r.text() : '')
        .then(html => { const ph = document.getElementById('nav-placeholder'); if (!ph) return;
            const container = document.createElement('div'); container.innerHTML = html;
            Array.from(container.querySelectorAll('link[rel="stylesheet"]')).forEach(l => {
                if (!document.querySelector('link[href="' + l.getAttribute('href') + '"]')) document.head.appendChild(l);
            });
            Array.from(container.querySelectorAll('link, script')).forEach(n => n.remove());
            ph.innerHTML = container.innerHTML;
            fetch('/navbar.html').then(r => r.text()).then(full => {
                const tmp = document.createElement('div'); tmp.innerHTML = full;
                Array.from(tmp.querySelectorAll('script[src]')).forEach(s => {
                    const nx = document.createElement('script'); nx.src = s.src; nx.defer = true; document.body.appendChild(nx);
                });
            }).catch(()=>{});
        })
        .catch(() => {});
    })();
  </script>

  <div class="box">
    <h1>Profile suchen</h1>
    <p>Suche nach registrierten Benutzer:innen (Benutzername oder E‑Mail).</p>
    <div style="display:flex;gap:8px;margin-bottom:12px;">
      <input id="q" placeholder="Benutzername oder E‑Mail suchen" style="flex:1;padding:8px;border:1px solid #ccc;border-radius:6px;" />
      <button id="searchBtn" style="padding:8px 12px;border-radius:6px;background:#0b62d6;color:#fff;border:0;">Suchen</button>
    </div>
    <div id="results"></div>
  </div>

  <script>
    async function search(q){
      const url = '/api/profiles' + (q ? '?q=' + encodeURIComponent(q) : '');
      const res = await fetch(url);
      if (!res.ok) return [];
      return res.json();
    }

    function renderResults(list){
      const container = document.getElementById('results'); container.innerHTML = '';
      if (!list || list.length === 0) { container.innerHTML = '<div class="meta">Keine Benutzer gefunden.</div>'; return; }
      list.forEach(user => {
        const el = document.createElement('div'); el.className = 'result';
        const info = document.createElement('div'); info.innerHTML = '<div style="font-weight:600">' + (user.username||'') + '</div><div class="meta">' + (user.email||'') + '</div>';
        const actions = document.createElement('div');
        const msgBtn = document.createElement('button'); msgBtn.textContent = 'Nachricht'; msgBtn.style.padding='6px 10px'; msgBtn.style.border='0'; msgBtn.style.borderRadius='6px'; msgBtn.style.background='#2b7cff'; msgBtn.style.color='#fff'; msgBtn.style.cursor='pointer';
        msgBtn.onclick = async function(){
          // try to get logged-in user from server session first
          let me = '';
          try{
            const r = await fetch('/api/whoami');
            if (r.ok) {
              const j = await r.json();
              me = j && j.username ? j.username : '';
            }
          }catch(e){ /* ignore */ }

          if (!me) {
            // fallback to previously stored local identifier or prompt
            me = localStorage.getItem('dualnet_me');
            if (!me) {
              me = prompt('Bitte gib deinen Benutzernamen an (wird lokal gespeichert):');
              if (!me) return; localStorage.setItem('dualnet_me', me);
            }
          }

          // start chat via API
          try{
            const resp = await fetch('/api/chats/start', { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ me: me, other: user.username || user.email }) });
            if (!resp.ok) { alert('Chat konnte nicht gestartet werden.'); return; }
            const j = await resp.json();
            // open messages panel and load chat
            if (window.DualNetChat && typeof window.DualNetChat.openChat === 'function') {
              window.DualNetChat.openChat(j.chatId, user.username || user.email);
            } else {
              // fallback: open messages page
              window.location.href = '/Homepage.html';
              alert('Bitte öffne die Nachrichtenleiste manuell.');
            }
          }catch(e){ console.error(e); alert('Fehler beim Starten des Chats.'); }
        };
        actions.appendChild(msgBtn);
        el.appendChild(info); el.appendChild(actions);
        container.appendChild(el);
      });
    }

    document.getElementById('searchBtn').addEventListener('click', async function(){ const q = document.getElementById('q').value.trim(); const res = await search(q); renderResults(res); });
    document.getElementById('q').addEventListener('keydown', async function(e){ if (e.key === 'Enter') { const res = await search(this.value.trim()); renderResults(res); } });

    // initial load: show all
    search('').then(renderResults).catch(()=>{});
  </script>
</body>
</html>
